<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Udacity Todos Course</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>
    <script src="https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
  </head>
  <body>
    <div>
      <h1>Todo List</h1>
      <input type="text" id='todo' placeholder="Add Todo"/>
      <button id="todobtn" type="button">Add Todo</button>
      <ul id='todos'>

      </ul>
    </div>
    <div>
      <h1>Goals</h1>
      <input type="text" id='goal' placeholder="Add Goal"/>
      <button id="goalbtn" type="button">Add Goal</button>
      <ul id='goals'>

      </ul>
    </div>

    <hr/>

    <div id='app'>
    </div>

    <script type="text/javascript">

      function generateId(){
        return Math.random().toString(36).substring(2) + (new Date()).getTime().toString(36);
      }

      //App Code

      const ADD_TODO='ADD_TODO'
      const REMOVE_TODO='REMOVE_TODO'
      const TOGGLE_TODO='TOGGLE_TODO'
      const ADD_GOAL='ADD_GOAL'
      const REMOVE_GOAL='REMOVE_GOAL'

      function addToDoAction(todo){
        return {
          type: ADD_TODO,
          todo
        }
      }

      function removeToDoAction(id){
        return {
          type: REMOVE_TODO,
          id
        }
      }

      function toggleToDoAction(id){
        return {
          type: TOGGLE_TODO,
          id
        }
      }

      function addGoalAction(goal){
        return {
          type: ADD_GOAL,
          goal
        }
      }

      function removeGoalAction(id){
        return {
          type: REMOVE_GOAL,
          id
        }
      }

      function todos(state=[],action) {
        switch(action.type){
          case ADD_TODO:
            return state.concat([action.todo])
          case REMOVE_TODO:
            return state.filter((todo) =>
              todo.id !== action.id
            )
          case TOGGLE_TODO:
            return state.map((todo) => todo.id!==action.id ? todo :
              Object.assign({},todo,{complete: !todo.complete}))
          default:
            return state
        }
      }

      function goals(state=[],action) {
        switch(action.type){
          case ADD_GOAL:
            return state.concat([action.goal])
          case REMOVE_GOAL:
            return state.filter((goal) =>
              goal.id !== action.id
            )
          default:
            return state
        }
      }

      const checker = (store) => (next) => (action) => {
        if(action.type===ADD_TODO && action.todo.name.toLowerCase().includes('bitcoin')){
          return alert("Nope. Not a good idea")
        }
        if(action.type===ADD_GOAL && action.goal.name.toLowerCase().includes('bitcoin')){
          return alert("Nope. Not a good idea")
        }
        return next(action)
      }

      const logger = (store) => (next) => (action) => {
        console.group(action.type)
          console.log('The action: ',action)
          const result = next(action)
          console.log('New state: ',store.getState())
        console.groupEnd()
        return result
      }

      const store=Redux.createStore(Redux.combineReducers({
        todos,
        goals
      }),Redux.applyMiddleware(checker,logger))

      store.subscribe(() => {
        const {goals,todos} = store.getState()

        document.getElementById('goals').innerHTML=''
        document.getElementById('todos').innerHTML=''

        goals.forEach(addGoalToDOM)
        todos.forEach(addTodoToDOM)
      })

      //DOM Code
      function addTodo(){
        const input= document.getElementById('todo')
        const name= input.value
        input.value=''
        store.dispatch(addToDoAction(
        {
          name,
          complete: false,
          id: generateId()
        }
        ))
      }

      function addGoal(){
        const input= document.getElementById('goal')
        const name= input.value
        input.value=''
        store.dispatch(addGoalAction(
        {
          name,
          id: generateId()
        }
        ))
      }

      function createRemoveButton(onClick){
        const removeButton= document.createElement('button')
        removeButton.innerHTML= 'X'
        removeButton.addEventListener('click', onClick)
        return removeButton
      }

      function addTodoToDOM(todo){
        const node= document.createElement('li')
        const text= document.createTextNode(todo.name)

        const removeButton = createRemoveButton(() => {
          store.dispatch(removeToDoAction(todo.id))
        })

        node.appendChild(text)
        node.appendChild(removeButton)

        node.style.textDecoration = todo.complete ? 'line-through': 'none'
        node.addEventListener('click', () => {
          store.dispatch(toggleToDoAction(todo.id))
        })
        document.getElementById('todos').appendChild(node)
      }

      function addGoalToDOM(goal){
        const node= document.createElement('li')
        const text= document.createTextNode(goal.name)

        const removeButton = createRemoveButton(() => {
          store.dispatch(removeGoalAction(goal.id))
        })

        node.appendChild(text)
        node.appendChild(removeButton)

        document.getElementById('goals').appendChild(node)
      }

      document.getElementById('todobtn').addEventListener('click',addTodo)
      document.getElementById('goalbtn').addEventListener('click',addGoal)

    </script>

    <script type='text/babel'>

     function List(props){
       return (
         <ul>
          {props.items.map((item) => (
            <li key={item.id}>
              <span onClick={()=> props.toggle && props.toggle(item) }
                style={{textDecoration: item.complete ? 'line-through': 'none'}}>
                {item.name}
              </span>
              <button onClick={() => props.remove(item)}>X</button>
            </li>
          ))}
         </ul>
       )
     }

     class Todos extends React.Component{

       removeItem = (todo) => {
         this.props.store.dispatch(removeToDoAction(todo.id))
       }

       toggleItem = (todo) => {
         this.props.store.dispatch(toggleToDoAction(todo.id))
       }

       addItem = (e) => {
         e.preventDefault()
         const name = this.input.value
         this.input.value=''

         this.props.store.dispatch(addToDoAction(
         {
           name,
           complete: false,
           id: generateId()
         }
         ))
       }

       render(){
         return (
           <div>
             <h1>Todo List</h1>
             <input type="text" placeholder="Add Todo" ref={(input)=> this.input=input } />
             <button type="button" onClick={this.addItem}>Add Todo</button>
             <List items={this.props.todos} remove={this.removeItem} toggle={this.toggleItem}/>
           </div>
         )
       }
     }

     class Goals extends React.Component{

       removeItem = (goal) => {
         this.props.store.dispatch(removeGoalAction(goal.id))
       }

       addItem = (e) => {
         e.preventDefault()
         const name = this.input.value
         this.input.value=''

         this.props.store.dispatch(addGoalAction(
         {
           name,
           id: generateId()
         }
         ))

       }

       render(){
         return (
           <div>
             <h1>Goals List</h1>
             <input type="text" placeholder="Add Goal" ref={(input)=> this.input=input } />
             <button type="button" onClick={this.addItem}>Add Todo</button>
             <List items={this.props.goals} remove={this.removeItem}/>
           </div>
         )
       }
     }

      class App extends React.Component {

        componentDidMount(){
          const {store} = this.props
          store.subscribe(() => this.forceUpdate())
        }

        render(){
          const {store} = this.props
          const {goals,todos} = store.getState()

          return (
            <div>
              <Todos todos={todos} store={this.props.store}/>
              <Goals goals={goals} store={this.props.store}/>
            </div>
          )
        }
      }

      ReactDOM.render(
        <App store={store}/>,
        document.getElementById('app')
      )
    </script>
  </body>
</html>
